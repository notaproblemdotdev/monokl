---
phase: 02-cli-adapters
plan: 03
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/monocli/adapters/jira.py
  - tests/test_jira_adapter.py
autonomous: true
must_haves:
  truths:
    - "Jira work items can be fetched via acli CLI using --json flag"
    - "Fetched items include: issue key, title (summary), status, priority, URL"
    - "Unauthenticated acli results in hidden section (no crash, no prompt)"
    - "Auth failures are detected and reported via CLIAuthError"
  artifacts:
    - path: "src/monocli/adapters/jira.py"
      provides: "JiraAdapter class for work item fetching"
      exports: ["JiraAdapter"]
    - path: "tests/test_jira_adapter.py"
      provides: "Async tests for Jira adapter"
  key_links:
    - from: "src/monocli/adapters/jira.py"
      to: "src/monocli/async_utils.CLIAdapter"
      via: "Class inheritance"
    - from: "src/monocli/adapters/jira.py"
      to: "src/monocli.models.JiraWorkItem"
      via: "fetch_and_parse() returns list[JiraWorkItem]"
    - from: "src/monocli/adapters/jira.py"
      to: "acli CLI"
      via: "subprocess execution"
---

<objective>
Implement the Jira CLI adapter that fetches work items assigned to the current user from the acli CLI, parses the JSON output into Pydantic models, and handles authentication failures gracefully.

Purpose: Fulfill DATA-02 and DATA-05 requirements - fetch Jira work items with all required fields (key, title, status, priority, URL).
Output: JiraAdapter class with fetch_assigned_items() method and comprehensive async tests.
</objective>

<execution_context>
@/Users/pg/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/pg/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/monocli/async_utils.py
@src/monocli/models.py
@src/monocli/exceptions.py
@src/monocli/adapters/detection.py
@tests/conftest.py

# From 02-01-SUMMARY (when available):
# - CLIDetector pattern for auth checking
# - DetectionRegistry for batch detection

# From 02-02-SUMMARY (when available):
# - GitLabAdapter as reference implementation
# - Similar patterns to follow for Jira
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement JiraAdapter class</name>
  <files>src/monocli/adapters/jira.py</files>
  <action>
Create src/monocli/adapters/jira.py with JiraAdapter class:

1. Class definition:
   - Inherit from CLIAdapter (from async_utils)
   - Initialize with cli_name="acli"
   - Store default issue list arguments

2. JiraAdapter methods:
   
   __init__(self):
     - Call super().__init__("acli")
     - Set default args for issue list command
   
   async fetch_assigned_items(
       self,
       status_filter: str = "!=Done",
       assignee: str = "@me"
   ) -> list[JiraWorkItem]:
     """Fetch Jira issues assigned to current user.
     
     Args:
         status_filter: Status filter (!=Done excludes completed items)
         assignee: Assignee filter (@me for current user)
     
     Returns:
         List of JiraWorkItem models
     
     Raises:
         CLINotFoundError: If acli is not installed
         CLIAuthError: If not authenticated to Jira
         CLIError: For other CLI failures
     """
     # Build command: acli jira issue list --json --assignee=@me --status!=Done
     args = [
         "jira", "issue", "list",
         "--json",
         f"--assignee={assignee}",
         f"--status{status_filter}"
     ]
     return await self.fetch_and_parse(args, JiraWorkItem)
   
   async check_auth(self) -> bool:
     """Check if acli is authenticated.
     
     Returns:
         True if authenticated, False otherwise
     
     Uses: acli whoami or acli jira me (or similar lightweight command)
     """
     try:
         await self.run(["whoami"], check=True)
         return True
     except (CLIAuthError, CLINotFoundError):
         return False

3. Key implementation details:
   - Use fetch_and_parse() from CLIAdapter base class
   - Returns list[JiraWorkItem] from models.py
   - JiraWorkItem uses nested fields structure (fields.summary, fields.status, etc.)
   - Leverage existing error handling (exceptions.py)
   - Add type hints and docstrings
   - Follow patterns in async_utils.py and gitlab.py

4. Import requirements:
   - from monocli.async_utils import CLIAdapter
   - from monocli.models import JiraWorkItem
   - from monocli.exceptions import CLIAuthError, CLINotFoundError

CLI command patterns from research:
- acli jira issue list --json --assignee=@me --status!=Done
- acli whoami (for auth check)

Note: acli (Atlassian CLI) vs jira CLI tool - use the correct command structure
based on what's actually available. The command may vary; adapt to real acli output.

Error handling:
- CLINotFoundError: acli not installed
- CLIAuthError: not logged in to Jira
- CLIError: network issues, invalid JQL, etc.
  </action>
  <verify>python -c "from monocli.adapters.jira import JiraAdapter; print('JiraAdapter import OK')"</verify>
  <done>
- JiraAdapter class exists and imports cleanly
- Inherits from CLIAdapter
- Has fetch_assigned_items() method
- Has check_auth() method
- mypy passes type checking
  </done>
</task>

<task type="auto">
  <name>Task 2: Write async tests for JiraAdapter</name>
  <files>tests/test_jira_adapter.py</files>
  <action>
Create tests/test_jira_adapter.py with comprehensive async tests:

1. Test fixtures:
   - sample_jira_json: Valid acli issue list --json output
   - sample_jira_invalid: Invalid/malformed JSON
   - mock_acli_auth_error: Simulated auth failure output

2. Test cases:

   test_fetch_assigned_items_success:
   - Mock successful acli jira issue list --json call
   - Mock JSON output with 2 issues
   - Verify returns list of 2 JiraWorkItem objects
   - Verify each has key, fields.summary, fields.status.name, fields.priority.name
   - Verify url property converts API URL to browser URL

   test_fetch_assigned_items_empty:
   - Mock empty JSON output ("[]")
   - Verify returns empty list

   test_fetch_assigned_items_not_installed:
   - Mock shutil.which to return None
   - Verify raises CLINotFoundError

   test_fetch_assigned_items_auth_failure:
   - Mock subprocess with auth error stderr
   - Verify raises CLIAuthError
   - Verify error message mentions authentication

   test_fetch_assigned_items_network_error:
   - Mock subprocess with timeout/non-zero exit
   - Verify raises CLIError with proper message

   test_check_auth_success:
   - Mock successful whoami command
   - Verify check_auth() returns True

   test_check_auth_failure:
   - Mock whoami with failure
   - Verify check_auth() returns False

   test_check_auth_not_installed:
   - Mock which returns None
   - Verify check_auth() returns False

3. Test patterns:
   - Use @pytest.mark.asyncio for all async tests
   - Use unittest.mock.patch for shutil.which
   - Use unittest.mock.patch for asyncio.create_subprocess_exec
   - Create MockProcess class for subprocess behavior
   - Test both happy path and error conditions

4. Sample JSON structure (from acli jira issue list --json):
   [
     {
       "key": "PROJ-123",
       "fields": {
         "summary": "Implement user authentication",
         "status": {"name": "In Progress"},
         "priority": {"name": "High"},
         "assignee": {"displayName": "John Doe"},
         "description": "Detailed description here"
       },
       "self": "https://company.atlassian.net/rest/api/2/issue/PROJ-123"
     }
   ]

5. Integration with detection (from 02-01):
   - Test that JiraAdapter integrates with CLIDetector pattern
   - Verify adapter can be registered in DetectionRegistry

6. Model property tests:
   - Verify JiraWorkItem.summary property extracts from fields
   - Verify JiraWorkItem.status property extracts status name
   - Verify JiraWorkItem.priority property extracts priority name
   - Verify JiraWorkItem.url property converts API URL to browser URL
  </action>
  <verify>uv run pytest tests/test_jira_adapter.py -v</verify>
  <done>
- All Jira adapter tests pass
- Tests cover success, empty, not installed, auth failure, network error
- Tests verify correct JiraWorkItem field mapping and properties
- Tests verify check_auth() behavior
- pytest-asyncio properly configured
  </done>
</task>

</tasks>

<verification>
1. Import test: python -c "from monocli.adapters.jira import JiraAdapter; print('OK')"
2. Type check: mypy src/monocli/adapters/jira.py passes
3. Test run: uv run pytest tests/test_jira_adapter.py -v (all pass)
4. Verify methods:
   - fetch_assigned_items() exists and is async
   - check_auth() exists and is async
   - Returns list[JiraWorkItem] on success
5. Integration: Can instantiate JiraAdapter and call methods
</verification>

<success_criteria>
- JiraAdapter inherits from CLIAdapter base class
- fetch_assigned_items() uses acli jira issue list --json --assignee=@me --status!=Done
- Returns list[JiraWorkItem] with validated fields
- Handles CLINotFoundError when acli not installed
- Handles CLIAuthError when not authenticated
- All async tests pass covering success and error cases
- Adapter integrates with DetectionRegistry from 02-01
- JiraWorkItem properties (summary, status, priority, url) work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-adapters/02-03-SUMMARY.md`
</output>
