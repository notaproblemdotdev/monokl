---
phase: 02-cli-adapters
plan: 02
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/monocli/adapters/gitlab.py
  - tests/test_gitlab_adapter.py
autonomous: true
must_haves:
  truths:
    - "GitLab MRs can be fetched via glab CLI using --json flag"
    - "Fetched MRs include: MR number (iid), title, status (state), author, URL"
    - "Unauthenticated glab results in hidden section (no crash, no prompt)"
    - "Auth failures are detected and reported via CLIAuthError"
  artifacts:
    - path: "src/monocli/adapters/gitlab.py"
      provides: "GitLabAdapter class for MR fetching"
      exports: ["GitLabAdapter"]
    - path: "tests/test_gitlab_adapter.py"
      provides: "Async tests for GitLab adapter"
  key_links:
    - from: "src/monocli/adapters/gitlab.py"
      to: "src/monocli/async_utils.CLIAdapter"
      via: "Class inheritance"
    - from: "src/monocli/adapters/gitlab.py"
      to: "src/monocli/models.MergeRequest"
      via: "fetch_and_parse() returns list[MergeRequest]"
    - from: "src/monocli/adapters/gitlab.py"
      to: "glab CLI"
      via: "subprocess execution"
---

<objective>
Implement the GitLab CLI adapter that fetches merge requests assigned to the current user from the glab CLI, parses the JSON output into Pydantic models, and handles authentication failures gracefully.

Purpose: Fulfill DATA-01 and DATA-04 requirements - fetch GitLab MRs with all required fields (number, title, status, author, URL).
Output: GitLabAdapter class with fetch_assigned_mrs() method and comprehensive async tests.
</objective>

<execution_context>
@/Users/pg/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/pg/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/monocli/async_utils.py
@src/monocli/models.py
@src/monocli/exceptions.py
@src/monocli/adapters/detection.py
@tests/conftest.py

# From 02-01-SUMMARY (when available):
# - CLIDetector pattern for auth checking
# - DetectionRegistry for batch detection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GitLabAdapter class</name>
  <files>src/monocli/adapters/gitlab.py</files>
  <action>
Create src/monocli/adapters/gitlab.py with GitLabAdapter class:

1. Class definition:
   - Inherit from CLIAdapter (from async_utils)
   - Initialize with cli_name="glab"
   - Store default MR list arguments

2. GitLabAdapter methods:
   
   __init__(self):
     - Call super().__init__("glab")
     - Set default args for MR list command
   
   async fetch_assigned_mrs(
       self,
       state: str = "opened",
       author: str = "@me"
   ) -> list[MergeRequest]:
     """Fetch MRs assigned to or authored by current user.
     
     Args:
         state: MR state filter (opened, closed, merged, all)
         author: Author filter (@me for current user)
     
     Returns:
         List of MergeRequest models
     
     Raises:
         CLINotFoundError: If glab is not installed
         CLIAuthError: If not authenticated to GitLab
         CLIError: For other CLI failures
     """
     # Build command: glab mr list --json --author=@me --state=opened
     args = [
         "mr", "list",
         "--json",
         f"--author={author}",
         f"--state={state}"
     ]
     return await self.fetch_and_parse(args, MergeRequest)
   
   async check_auth(self) -> bool:
     """Check if glab is authenticated.
     
     Returns:
         True if authenticated, False otherwise
     
     Uses: glab auth status (or similar lightweight command)
     """
     try:
         await self.run(["auth", "status"], check=True)
         return True
     except (CLIAuthError, CLINotFoundError):
         return False

3. Key implementation details:
   - Use fetch_and_parse() from CLIAdapter base class
   - Returns list[MergeRequest] from models.py
   - Leverage existing error handling (exceptions.py)
   - Add type hints and docstrings
   - Follow patterns in async_utils.py

4. Import requirements:
   - from monocli.async_utils import CLIAdapter
   - from monocli.models import MergeRequest
   - from monocli.exceptions import CLIAuthError, CLINotFoundError

CLI command patterns from research:
- glab mr list --json --author=@me --state=opened
- glab auth status (for auth check)

Error handling:
- CLINotFoundError: glab not installed
- CLIAuthError: not logged in to GitLab
- CLIError: network issues, invalid args, etc.
  </action>
  <verify>python -c "from monocli.adapters.gitlab import GitLabAdapter; print('GitLabAdapter import OK')"</verify>
  <done>
- GitLabAdapter class exists and imports cleanly
- Inherits from CLIAdapter
- Has fetch_assigned_mrs() method
- Has check_auth() method
- mypy passes type checking
  </done>
</task>

<task type="auto">
  <name>Task 2: Write async tests for GitLabAdapter</name>
  <files>tests/test_gitlab_adapter.py</files>
  <action>
Create tests/test_gitlab_adapter.py with comprehensive async tests:

1. Test fixtures (in conftest.py or local):
   - sample_mr_json: Valid glab MR list --json output
   - sample_mr_invalid: Invalid/malformed JSON
   - mock_glab_auth_error: Simulated auth failure output

2. Test cases:

   test_fetch_assigned_mrs_success:
   - Mock successful glab mr list --json call
   - Mock JSON output with 2 MRs
   - Verify returns list of 2 MergeRequest objects
   - Verify each has iid, title, state, author, web_url

   test_fetch_assigned_mrs_empty:
   - Mock empty JSON output ("[]")
   - Verify returns empty list

   test_fetch_assigned_mrs_not_installed:
   - Mock shutil.which to return None
   - Verify raises CLINotFoundError

   test_fetch_assigned_mrs_auth_failure:
   - Mock subprocess with auth error stderr
   - Verify raises CLIAuthError
   - Verify error message mentions authentication

   test_fetch_assigned_mrs_network_error:
   - Mock subprocess with timeout/non-zero exit
   - Verify raises CLIError with proper message

   test_check_auth_success:
   - Mock successful auth status command
   - Verify check_auth() returns True

   test_check_auth_failure:
   - Mock auth status with failure
   - Verify check_auth() returns False

   test_check_auth_not_installed:
   - Mock which returns None
   - Verify check_auth() returns False

3. Test patterns:
   - Use @pytest.mark.asyncio for all async tests
   - Use unittest.mock.patch for shutil.which
   - Use unittest.mock.patch for asyncio.create_subprocess_exec
   - Create MockProcess class for subprocess behavior
   - Test both happy path and error conditions

4. Sample JSON structure (from glab mr list --json):
   [
     {
       "iid": 123,
       "title": "Fix bug in auth",
       "state": "opened",
       "author": {"name": "John Doe", "username": "johndoe"},
       "web_url": "https://gitlab.com/org/repo/-/merge_requests/123",
       "source_branch": "feature/auth-fix",
       "target_branch": "main",
       "created_at": "2024-01-15T10:30:00Z",
       "draft": false
     }
   ]

5. Integration with detection (from 02-01):
   - Test that GitLabAdapter integrates with CLIDetector pattern
   - Verify adapter can be registered in DetectionRegistry
  </action>
  <verify>uv run pytest tests/test_gitlab_adapter.py -v</verify>
  <done>
- All GitLab adapter tests pass
- Tests cover success, empty, not installed, auth failure, network error
- Tests verify correct MR field mapping
- Tests verify check_auth() behavior
- pytest-asyncio properly configured
  </done>
</task>

</tasks>

<verification>
1. Import test: python -c "from monocli.adapters.gitlab import GitLabAdapter; print('OK')"
2. Type check: mypy src/monocli/adapters/gitlab.py passes
3. Test run: uv run pytest tests/test_gitlab_adapter.py -v (all pass)
4. Verify methods:
   - fetch_assigned_mrs() exists and is async
   - check_auth() exists and is async
   - Returns list[MergeRequest] on success
5. Integration: Can instantiate GitLabAdapter and call methods
</verification>

<success_criteria>
- GitLabAdapter inherits from CLIAdapter base class
- fetch_assigned_mrs() uses glab mr list --json --author=@me --state=opened
- Returns list[MergeRequest] with validated fields
- Handles CLINotFoundError when glab not installed
- Handles CLIAuthError when not authenticated
- All async tests pass covering success and error cases
- Adapter integrates with DetectionRegistry from 02-01
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-adapters/02-02-SUMMARY.md`
</output>
