---
phase: 03-dashboard-ui
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/monocli/ui/main_screen.py
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Dashboard sections load data and stop showing loading spinners"
    - "Loading spinners resolve to either data, empty, or error state"
    - "Workers use Textual 7.x API instead of deprecated @work decorator"
  artifacts:
    - path: "src/monocli/ui/main_screen.py"
      provides: "MainScreen with run_worker() calls instead of @work decorator"
      changes:
        - "Remove 'from textual import work' import"
        - "Remove @work(exclusive=True) from fetch_merge_requests()"
        - "Remove @work(exclusive=True) from fetch_work_items()"
        - "Update detect_and_fetch() to call run_worker() methods"
  key_links:
    - from: "detect_and_fetch()"
      to: "fetch_merge_requests"
      via: "self.run_worker(self.fetch_merge_requests(), exclusive=True)"
    - from: "detect_and_fetch()"
      to: "fetch_work_items"
      via: "self.run_worker(self.fetch_work_items(), exclusive=True)"
---

# Gap Closure Plan 04: Fix Textual Workers API

## Objective
Replace deprecated `@work(exclusive=True)` decorator with the Textual 7.x `run_worker()` method to fix infinite loading spinners.

**Purpose:** The `@work` decorator was removed in Textual 7.x. The current code uses it on `fetch_merge_requests()` and `fetch_work_items()` methods, causing workers to never execute and spinners to spin forever.

**Output:** Updated `main_screen.py` using the new `self.run_worker()` API.

## Execution Context
@/.planning/ROADMAP.md
@/.planning/STATE.md
@/.planning/phases/03-dashboard-ui/03-dashboard-ui-UAT.md

## Context

**Gap Being Closed:**
- Gap 1: Dashboard sections load data and stop showing loading spinners
- Gap 2: Loading spinners resolve to either data, empty, or error state

**Root Cause:** Code uses deprecated `@work(exclusive=True)` decorator which was removed in Textual 7.x. Workers never execute, so spinner stays in LOADING state forever.

**Files to Modify:**
- `src/monocli/ui/main_screen.py` - Lines 16, 130, 162

**Textual 7.x Migration:**
- OLD: `from textual import work` + `@work(exclusive=True)` on async methods
- NEW: `self.run_worker(coro, exclusive=True)` called from non-async methods

## Tasks

<task type="auto">
  <name>Fix Textual Workers API in MainScreen</name>
  <files>src/monocli/ui/main_screen.py</files>
  <action>
Replace the deprecated @work decorator pattern with Textual 7.x run_worker() API:

1. Remove the import:
   - Delete line 16: `from textual import work`

2. Modify fetch_merge_requests() (lines 130-160):
   - Remove `@work(exclusive=True)` decorator from line 130
   - Keep the method as `async def fetch_merge_requests(self) -> None:`
   - All internal logic stays the same

3. Modify fetch_work_items() (lines 162-192):
   - Remove `@work(exclusive=True)` decorator from line 162  
   - Keep the method as `async def fetch_work_items(self) -> None:`
   - All internal logic stays the same

4. Update detect_and_fetch() method (lines 114-128):
   - Keep the CLIDetector registrations (lines 122-124)
   - Replace lines 127-128 with run_worker() calls:
     ```python
     # Start detection and fetching using run_worker API
     self.run_worker(self.fetch_merge_requests(), exclusive=True)
     self.run_worker(self.fetch_work_items(), exclusive=True)
     ```

The run_worker() method is available on Screen/Textual widgets and runs the coroutine as a background worker with exclusive=True to prevent race conditions.
  </action>
  <verify>
Run the UI tests to verify the fix:
```bash
uv run pytest tests/ui/test_main_screen.py -v -x
```

Check the file syntax is valid:
```bash
uv run ruff check src/monocli/ui/main_screen.py
```
  </verify>
  <done>
- No `from textual import work` import exists
- No `@work(exclusive=True)` decorators exist
- `detect_and_fetch()` calls `self.run_worker()` for both fetch methods
- Tests pass without import errors or runtime errors
  </done>
</task>

## Verification

After completing this plan:
- [ ] Import `from textual import work` is removed
- [ ] `@work(exclusive=True)` decorators removed from fetch methods
- [ ] `detect_and_fetch()` uses `self.run_worker(coro, exclusive=True)` 
- [ ] Syntax check passes (`ruff check`)
- [ ] UI tests pass (`pytest tests/ui/`)

## Success Criteria

1. **Observable:** Loading spinners appear briefly then resolve to data, empty, or error state
2. **Code Quality:** No deprecated Textual APIs used
3. **Test Coverage:** Existing UI tests continue to pass
4. **Compatibility:** Works with Textual 7.x

## Output

After completion, create: `.planning/phases/03-dashboard-ui/03-04-SUMMARY.md`
